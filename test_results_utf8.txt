docker :  Container 
sujet_cnam-minio-1  
Running
Au caractère Ligne:1 : 
1
+ docker compose run 
-T --rm api pytest -v 
> test_results.txt 2>&1
+ ~~~~~~~~~~~~~~~~~~~~~
~~~~~~~~~~~~~~~~~~~~~~~
~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo     
         : NotSpecifi  
  ed: ( Container su   
 jet_cnam-minio-1      
Running:String) []    
, RemoteException
    + FullyQualifiedEr 
   rorId : NativeComm  
  andError
 
 Container 
sujet_cnam-db-1  
Running
============================= test session starts ==============================
platform linux -- Python 3.11.14, pytest-7.4.4, pluggy-1.6.0 -- /usr/local/bin/python3.11
cachedir: .pytest_cache
rootdir: /app
plugins: asyncio-0.23.4, anyio-4.12.1
asyncio: mode=Mode.STRICT
collecting ... collected 12 items

tests/test_audit_chain.py::test_audit_chain_ok FAILED                    [  8%]
tests/test_audit_chain.py::test_audit_chain_detects_corruption FAILED    [ 16%]
tests/test_db_models.py::test_insert_and_read_separated_silos PASSED     [ 25%]
tests/test_health.py::test_health_returns_ok PASSED                      [ 33%]
tests/test_iam.py::test_db_role_is_not_privileged_and_has_needed_grants PASSED [ 41%]
tests/test_paillier.py::test_encrypt_decrypt_roundtrip PASSED            [ 50%]
tests/test_paillier.py::test_homomorphic_addition PASSED                 [ 58%]
tests/test_paillier.py::test_add_plaintext_optimization PASSED           [ 66%]
tests/test_upload_photo.py::test_upload_photo_stores_object_and_metadata PASSED [ 75%]
tests/test_votes_aggregate.py::test_aggregate_votes_homomorphic_sum FAILED [ 83%]
tests/test_votes_aggregate.py::test_aggregate_no_votes_returns_zero PASSED [ 91%]
tests/test_votes_send.py::test_send_vote_stores_ciphertext_and_audit FAILED [100%]

=================================== FAILURES ===================================
_____________________________ test_audit_chain_ok ______________________________

    @pytest.mark.anyio
    async def test_audit_chain_ok():
        engine = get_engine()
        await init_db(engine)
        await reset_db(engine)
    
        payload = {
            "question_id": "Q-audit",
            "participant_id": f"p-{uuid.uuid4()}",
            "agent_id": f"a-{uuid.uuid4()}",
            "ciphertext": "123",
            "key_id": "key-v1",
        }
    
        async with AsyncClient(app=app, base_url="http://test") as client:
            resp = await client.post("/votes/send", json=payload)
>           assert resp.status_code == 201
E           assert 400 == 201
E            +  where 400 = <Response [400 Bad Request]>.status_code

tests/test_audit_chain.py:27: AssertionError
_____________________ test_audit_chain_detects_corruption ______________________

    @pytest.mark.anyio
    async def test_audit_chain_detects_corruption():
        engine = get_engine()
        await init_db(engine)
        await reset_db(engine)
    
        async with AsyncClient(app=app, base_url="http://test") as client:
            for i in range(2):
                payload = {
                    "question_id": f"Q-corrupt-{i}",
                    "participant_id": f"p-{uuid.uuid4()}",
                    "agent_id": f"a-{uuid.uuid4()}",
                    "ciphertext": str(100 + i),
                    "key_id": "key-v1",
                }
                resp = await client.post("/votes/send", json=payload)
>               assert resp.status_code == 201
E               assert 400 == 201
E                +  where 400 = <Response [400 Bad Request]>.status_code

tests/test_audit_chain.py:51: AssertionError
_____________________ test_aggregate_votes_homomorphic_sum _____________________

    @pytest.mark.anyio
    async def test_aggregate_votes_homomorphic_sum():
        engine = get_engine()
        await init_db(engine)
        await reset_db(engine)
    
        pub, priv = get_demo_keypair()
        question_id = "Q-agg"
    
        c1 = encrypt(pub, 1)
        c2 = encrypt(pub, 1)
    
        payloads = [
            {
                "question_id": question_id,
                "participant_id": f"participant-{uuid.uuid4()}",
                "agent_id": f"agent-{uuid.uuid4()}",
                "ciphertext": str(c1),
                "key_id": DEMO_KEY_ID,
            },
            {
                "question_id": question_id,
                "participant_id": f"participant-{uuid.uuid4()}",
                "agent_id": f"agent-{uuid.uuid4()}",
                "ciphertext": str(c2),
                "key_id": DEMO_KEY_ID,
            },
        ]
    
        async with AsyncClient(app=app, base_url="http://test") as client:
            for payload in payloads:
                resp = await client.post("/votes/send", json=payload)
>               assert resp.status_code == 201
E               assert 400 == 201
E                +  where 400 = <Response [400 Bad Request]>.status_code

tests/test_votes_aggregate.py:43: AssertionError
__________________ test_send_vote_stores_ciphertext_and_audit __________________

    @pytest.mark.anyio
    async def test_send_vote_stores_ciphertext_and_audit():
        engine = get_engine()
        await init_db(engine)
        await reset_db(engine)
    
        participant = f"participant-{uuid.uuid4()}"
        agent = f"agent-{uuid.uuid4()}"
        question_id = "Q1"
        ciphertext = "ciphertext-demo"
        key_id = "key-v1"
    
        payload = {
            "question_id": question_id,
            "participant_id": participant,
            "agent_id": agent,
            "ciphertext": ciphertext,
            "key_id": key_id,
        }
    
        async with AsyncClient(app=app, base_url="http://test") as client:
            response = await client.post("/votes/send", json=payload)
    
>       assert response.status_code == 201, "POST /votes/send should return 201"
E       AssertionError: POST /votes/send should return 201
E       assert 400 == 201
E        +  where 400 = <Response [400 Bad Request]>.status_code

tests/test_votes_send.py:42: AssertionError
=========================== short test summary info ============================
FAILED tests/test_audit_chain.py::test_audit_chain_ok - assert 400 == 201
FAILED tests/test_audit_chain.py::test_audit_chain_detects_corruption - asser...
FAILED tests/test_votes_aggregate.py::test_aggregate_votes_homomorphic_sum - ...
FAILED tests/test_votes_send.py::test_send_vote_stores_ciphertext_and_audit
========================= 4 failed, 8 passed in 4.73s ==========================

